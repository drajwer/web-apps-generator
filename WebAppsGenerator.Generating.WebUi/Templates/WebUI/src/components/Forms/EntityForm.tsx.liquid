import * as React from 'react';
import {{Params.Entity.Name}} from 'src/models/{{Params.Entity.Name}}';
import { Grid } from '@material-ui/core';
{%- for field in Params.Entity.Fields -%}
	{%- unless field.Name == 'id' -%}
		{%- unless field.Type.Name == 'boolean' -%}
import { TextField } from '@material-ui/core';
			{%- break -%}
		{%- endunless -%}
	{%- endunless -%}
{%- endfor -%}
{%- for field in Params.Entity.Fields -%}
	{%- if field.Type.Name == 'boolean' -%}
		{%- unless field.Type.IsNullable -%}
import { FormControlLabel, Checkbox } from '@material-ui/core';
		{%- break -%}
		{%- endunless -%}
	{%- endif -%}
{%- endfor -%}
{%- for field in Params.Entity.Fields -%}
	{%- if field.Type.Name == 'boolean' -%}
		{%- if field.Type.IsNullable -%}
import { MenuItem } from '@material-ui/core';
		{%- break -%}
		{%- endif -%}
	{%- endif -%}
{%- endfor -%}
{%- for field in Params.Entity.Fields -%}
	{%- if field.Type.Name == 'Date' -%}
import { DateTimePicker } from 'material-ui-pickers';
		{%- break -%}
	{%- endif -%}
{%- endfor -%}
{%- for field in Params.Entity.Fields -%}
	{%- if field.Relation.HasOne or field.Relation.HasMany -%}
import {{ field.Type.EntityName }}Modal from 'src/components/Modals/{{ field.Type.EntityName }}/{{ field.Type.EntityName }}Modal';
	{%- endif -%}
{%- endfor -%}
interface IProps {
    {{Params.Entity.Name | DeCapitalize}}: {{Params.Entity.Name}}
    readonly: boolean
    on{{Params.Entity.Name}}Change: ({{Params.Entity.Name | DeCapitalize}}: {{Params.Entity.Name}}) => void
}
{%- assign createState = false -%}
{%- for field in Params.Entity.Fields -%}
		{%- if field.Relation.HasOne or field.Relation.HasMany -%}
			{%- assign createState = true -%}
		{%- endif -%}
{%- endfor -%}
{%- if createState -%}
interface IState {
	{%- for field in Params.Entity.Fields -%}
		{%- if field.Relation.HasOne or field.Relation.HasMany -%}
	open{{field.Name}}Modal: boolean
		{%- endif -%}
	{%- endfor -%}
}
{%- endif -%}

class {{Params.Entity.Name}}Form extends React.Component<IProps, {%- if createState -%}IState{%-else-%}{}{%-endif -%}> {
	constructor(props: IProps) {
		super(props);
		this.state = { 
		{%- for field in Params.Entity.Fields -%}
			{%- if field.Relation.HasOne or field.Relation.HasMany -%}
			open{{field.Name}}Modal: false,
			{%- endif -%}
		{%- endfor -%}
		};
	}
    public render() {
        return (
            <Grid container={true} spacing={24}>
			{%- for field in Params.Entity.Fields -%}
				{%- if field.Relation.HasOne or field.Relation.HasMany -%}
				<{{ field.Type.EntityName }}Modal
					{%- if field.Relation.HasMany -%}
					multiple = {true}
						{%- else -%}
					multiple = {false}
					{%- endif -%}
					open={this.state.open{{ field.Name }}Modal}
					onClose={this.toggle{{ field.Name }}Modal}
					onSave={this.on{{ field.Name }}Change}
					{%- if field.Relation.HasMany -%}
					selected = {this.props.{{Params.Entity.Name | DeCapitalize}}.{{field.Name}}Ids}
						{%- else -%}
					selected = { this.props.{{Params.Entity.Name | DeCapitalize}}.{{field.Name}}Id != null ? [this.props.{{Params.Entity.Name | DeCapitalize}}.{{field.Name}}Id] : [] }
					{%- endif -%}
				/>
				{%- endif -%}
			{%- endfor -%}
			{%- assign addPlaceholder = true -%}
			{%- for field in Params.Entity.Fields -%}
				{%- unless field.Name == 'id' -%}
				{%- assign addPlaceholder = false -%}
				<Grid item={true} xs={12} sm={4}>
					{%- if field.Type.IsSimpleType -%}
						{%- if field.Type.Name == 'boolean' -%}
							{%- if field.Type.IsNullable -%}
							<TextField
								id="{{ field.Name }}"
								label="{{field.Name | SplitCamelCase | Capitalize}}"
								select={true}
								required={false}
								value={this.props.{{Params.Entity.Name | DeCapitalize }}.{{ field.Name | DeCapitalize }} == null ? "" : this.props.{{Params.Entity.Name | DeCapitalize }}.{{ field.Name | DeCapitalize }}.toString()}
								onChange={this.on{{ field.Name }}Change}
								disabled={this.props.readonly}
								fullWidth={true}
							>
								<MenuItem key={"undefined"} value={""}>
									None
								</MenuItem>
								<MenuItem key={"true"} value={"true"}>
									True
								</MenuItem>
								<MenuItem key={"false"} value={"false"}>
									False
								</MenuItem>
							</TextField>
							{%- else -%}
							<FormControlLabel
								label="{{ field.Name | SplitCamelCase | Capitalize }}"
								control={
									<Checkbox
										id="{{ field.Name | DeCapitalize }}"
										checked={this.props.{{Params.Entity.Name | DeCapitalize }}.{{ field.Name | DeCapitalize }} == null ? false : this.props.{{Params.Entity.Name | DeCapitalize }}.{{ field.Name | DeCapitalize }}}
										onChange={this.on{{ field.Name }}Change}
										color="primary"
										disabled={this.props.readonly}
									/>
								}
							/>
							{%- endif -%}
						{%- elsif field.Type.Name == 'Date' -%}
					<DateTimePicker
						id="{{field.Name}}"
						name="{{field.Name | SplitCamelCase | Capitalize}}"
						label="{{field.Name | SplitCamelCase | Capitalize}}"
						value={this.props.{{Params.Entity.Name | DeCapitalize}}.{{field.Name}} == null ? null : this.props.{{Params.Entity.Name | DeCapitalize}}.{{field.Name}}}
						onChange={this.on{{field.Name}}Change}
						showTodayButton={true}
						{%- if field.Type.IsNullable -%}
						clearable={true}
						required={false}
						{%-else-%}
						clearable={false}
						required={true}
						{%-endif-%}
						fullWidth={true}
						disabled={this.props.readonly}
					/>
						{%- else -%}
					<TextField
					{%- if field.Type.IsNullable -%}
					  required={false}
					{%-else-%}
					  required={true}
					{%-endif-%}
					  id="{{field.Name}}"
					  name="{{field.Name | SplitCamelCase | Capitalize}}"
					  label="{{field.Name | SplitCamelCase | Capitalize}}"
						{%- if field.Type.Name == 'number' -%}
					  type="{{ field.Type.Name }}"
						{%- endif -%}
					  fullWidth={true}
						{%- if field.Type.Name == 'number' -%}
					  value = { this.props.{{Params.Entity.Name | DeCapitalize}}.{{field.Name}} == null || isNaN(this.props.{{Params.Entity.Name | DeCapitalize}}.{{field.Name}}) ? "" : this.props.{{Params.Entity.Name | DeCapitalize}}.{{field.Name}} }
						{%- else -%}
					  value = { this.props.{{Params.Entity.Name | DeCapitalize}}.{{field.Name}} == null ? "" : this.props.{{Params.Entity.Name | DeCapitalize}}.{{field.Name}} }
						{%- endif -%}
					  disabled={this.props.readonly}
					  onChange={this.on{{ field.Name }}Change}
					/>
						{%- endif -%}
					{%- else -%}
					<TextField
					  required={true}
					  id="{{field.Name}}"
					  name="{{field.Name | SplitCamelCase | Capitalize}}"
					  label="{{field.Name | SplitCamelCase | Capitalize}}"
					  type="string"
					  fullWidth={true}
						{%- if field.Relation.HasMany -%}
					  value = {`${this.props.{{Params.Entity.Name | DeCapitalize}}.{{field.Name}}Ids.length} selected`}
						{%- else -%}
					  value = { this.props.{{Params.Entity.Name | DeCapitalize}}.{{field.Name}}Id == null ? 'Empty' : 'Item selected' }
						{%- endif -%}
					  disabled={this.props.readonly}
					  onClick={this.toggle{{field.Name}}Modal}
					/>
					{%- endif -%}
				</Grid>
				{%- endunless -%}
			{%- endfor -%}
			{%- if addPlaceholder -%}
			<div>This form is empty. Please check the input file.</div>
			{%- endif -%}
            </Grid>
        )
    }
	{%- for field in Params.Entity.Fields -%}
		{%- if field.Type.IsSimpleType -%}
			{%- unless field.Name == 'id' -%}
				{%- if field.Type.Name == 'Date' -%}
	private on{{field.Name}}Change = (date: Date {% if field.Type.IsNullable -%}| null {%-endif-%}) => { 
				{%- else -%}
	private on{{field.Name}}Change = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
				{%- endif -%}
		const {{Params.Entity.Name | DeCapitalize}} = {...this.props.{{Params.Entity.Name | DeCapitalize}}};
	{%- if field.Type.IsNullable -%}
		{%- if field.Type.Name == 'Date' -%}
		if (date == null) { 
		{%- else -%}
		if(e.target.value === "") {
		{%- endif -%}
			{{Params.Entity.Name | DeCapitalize}}.{{field.Name}} = undefined;
			this.props.on{{Params.Entity.Name}}Change({{Params.Entity.Name | DeCapitalize}});
			return;
		}
	{%- endif -%}
		{%- if field.Type.Name == 'number' -%}
		{{Params.Entity.Name | DeCapitalize}}.{{field.Name}} = {%if field.Type.IsFloat -%}parseFloat(e.target.value){%-else-%}parseInt(e.target.value, 10){%-endif-%};
		{%- elsif field.Type.Name == 'boolean' -%}
			{%- if field.Type.IsNullable -%}
		{{Params.Entity.Name | DeCapitalize}}.{{field.Name}} = e.target.value === "true";
			{%- else -%}
		{{Params.Entity.Name | DeCapitalize}}.{{field.Name}} = !{{Params.Entity.Name | DeCapitalize}}.{{field.Name}};
			{%- endif -%}
		{%- elsif field.Type.Name == 'Date' -%}	
		{{Params.Entity.Name | DeCapitalize}}.{{field.Name}} = date;
		{%- else -%}
		{{Params.Entity.Name | DeCapitalize}}.{{field.Name}} = e.target.value;
		{%- endif -%}
		this.props.on{{Params.Entity.Name}}Change({{Params.Entity.Name | DeCapitalize}});
    }
			{%- endunless -%}
		{%- else -%}


	private toggle{{ field.Name }}Modal = () => {
		if (!this.props.readonly) {
			this.setState({ open{{ field.Name }}Modal: !this.state.open{{ field.Name }}Modal });
		}
	}

	private on{{ field.Name }}Change = (selected: number[]) => {
		const {{Params.Entity.Name | DeCapitalize}} = {...this.props.{{Params.Entity.Name | DeCapitalize}}};
		{%- if field.Relation.HasMany -%}
		{{Params.Entity.Name | DeCapitalize}}.{{ field.Name }}Ids = selected;
		{%- else -%}
		{{Params.Entity.Name | DeCapitalize}}.{{ field.Name }}Id = selected.length > 0 ? selected[0] : undefined;
		{%- endif -%}
		this.props.on{{Params.Entity.Name}}Change({{Params.Entity.Name | DeCapitalize}});
	}
		{%- endif -%}
	{%- endfor -%}
}

export default {{Params.Entity.Name}}Form;