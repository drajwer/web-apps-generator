using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using {{Params.CoreProjectName}}.Interfaces;
using {{Params.CoreProjectName}}.Models;
using Microsoft.EntityFrameworkCore;

namespace {{Params.CoreProjectName}}.Services.Generated
{
    /// <summary>
    /// Autogenerated. To modify the logic use <see cref="{{Params.Entity.Name}}CrudService"/>.
    /// </summary>
    public partial class {{Params.Entity.Name}}BaseCrudService : ICrudService<{{Params.Entity.Name}}, {{Params.Entity.IdField.Type.Name}}>
    {
        protected readonly IRepository<{{Params.Entity.Name}}, {{Params.Entity.IdField.Type.Name}}> Repo;
		protected readonly RepositorySet RepoSet;

        public {{Params.Entity.Name}}BaseCrudService(RepositorySet repoSet)
        {
            Repo = repoSet.{{Params.Entity.Name}}Repo;
			RepoSet = repoSet;
        }

        public {{Params.Entity.Name}} Create({{Params.Entity.Name}} entity)
        {
			{%- for prop in Params.Entity.Fields -%}
				{%- unless prop.Relation == nil -%}
					{%- unless prop.Type.IsSimpleType -%}
			Init{{prop.Name}}(entity);
					{%- endunless -%}
				{%- endunless -%}
			{%- endfor -%}
            Repo.Create(entity);
            return Get(entity.Id);
        }

        public void Delete({{Params.Entity.IdField.Type.Name}} id)
        {
            var entity = Get(id);
            if(entity == null)
                throw new ArgumentException($"{{Params.Entity.Name}} with id {id} does not exists.");
            Repo.Delete(entity);
        }

        public {{Params.Entity.Name}} Get({{Params.Entity.IdField.Type.Name}} id)
        {
            return Repo.Get(id);
        }

        public {{Params.Entity.Name}} GetWithChildren({{Params.Entity.IdField.Type.Name}} id)
        {
            return Repo.GetAll()
			{%- for prop in Params.Entity.Fields -%}
				{%- unless prop.Relation == nil -%}
					{%- unless prop.Type.IsSimpleType -%}
				.Include(e => e.{{prop.Name}})
					{%- endunless -%}
				{%- endunless -%}
			{%- endfor -%}
                .FirstOrDefault(e => e.Id == id);
        }

        public IQueryable<{{Params.Entity.Name}}> GetAll()
        {
            return Repo.GetAll();
        }

        public {{Params.Entity.Name}} Update({{Params.Entity.IdField.Type.Name}} id, {{Params.Entity.Name}} entity)
        {
            var dbEntity = GetWithChildren(id);
            if (dbEntity == null)
                throw new ArgumentException($"{{Params.Entity.Name}} with id {id} does not exists.");
			
            UpdateSimpleProperties(entity, dbEntity);
            {%- for prop in Params.Entity.Fields -%}
				{%- unless prop.Relation == nil -%}
					{%- unless prop.Type.IsSimpleType -%}
			Update{{prop.Name}}(entity, dbEntity);
					{%- endunless -%}
				{%- endunless -%}
			{%- endfor -%}

            Repo.Update(dbEntity);

            return Get(id);
        }

		{%- for prop in Params.Entity.Fields -%}
			{%- unless prop.Relation == null -%}
				{%- unless prop.Type.IsSimpleType -%}
		protected virtual void Init{{prop.Name}}({{Params.Entity.Name}} entity)
        {
            {%- if prop.Relation.HasManyWithOne -%}
			entity.{{prop.Name}} = entity.{{prop.Name}}.Select(e => RepoSet.{{prop.Type.EntityName}}Repo.Get(e.Id)).ToList();
			{%- endif -%}
        }

				{%- endunless -%}
			{%- endunless -%}
		{%- endfor -%}

		{%- for prop in Params.Entity.Fields -%}
			{%- unless prop.Relation == nil -%}
				{%- unless prop.Type.IsSimpleType -%}
		protected virtual void Update{{prop.Name}}({{Params.Entity.Name}} entity, {{Params.Entity.Name}} dbEntity)
        {
            {%- if prop.Relation.HasManyWithMany -%}
			dbEntity.{{prop.Name}} = entity.{{prop.Name}};
			{%- elsif prop.Relation.HasManyWithOne -%}
			dbEntity.{{prop.Name}} = dbEntity.{{prop.Name}}.Where(e => entity.{{prop.Name}}.Any(n => n.Id == e.Id)).ToList();
            foreach (var child in dbEntity.{{prop.Name}})
            {
                if (entity.{{prop.Name}}.All(e => e.Id != child.Id))
                    dbEntity.{{prop.Name}}.Remove(child);
            }

            var children = entity.{{prop.Name}}.Select(s => RepoSet.{{prop.Type.EntityName}}Repo.Get(s.Id)).ToList();
            foreach (var child in children)
            {
                child.{{prop.Relation.SecondFieldName}}Id = dbEntity.Id;
            }
			{%- else -%}
			dbEntity.{{prop.Name}}Id = entity.{{prop.Name}}Id;
			{%- endif -%}
        }

				{%- endunless -%}
			{%- endunless -%}
		{%- endfor -%}

        protected virtual void UpdateSimpleProperties({{Params.Entity.Name}} entity, {{Params.Entity.Name}} dbEntity)
        {
			{%- for prop in Params.Entity.Fields -%}
				{%- if prop.Type.IsSimpleType and prop.Relation == nil -%}
					{%- unless prop.Name == 'Id' -%}					
			dbEntity.{{prop.Name}} = entity.{{prop.Name}};
					{%- endunless -%}
				{%- endif -%}
			{%- endfor -%}
        }
    }
}
